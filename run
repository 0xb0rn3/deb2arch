#!/usr/bin/env bash
set -e

VERSION="0.0.1"
REPO_URL="https://github.com/0xb0rn3/deb2arch"
SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

check_updates() {
    if [ -d "${SCRIPT_DIR}/.git" ]; then
        echo -ne "${CYAN}ðŸ” Checking for updates...${NC}"
        
        git -C "${SCRIPT_DIR}" fetch origin main 2>/dev/null || {
            echo -e "\r${YELLOW}âš ï¸  Could not check for updates${NC}"
            return
        }
        
        LOCAL=$(git -C "${SCRIPT_DIR}" rev-parse HEAD 2>/dev/null)
        REMOTE=$(git -C "${SCRIPT_DIR}" rev-parse origin/main 2>/dev/null)
        
        if [ "$LOCAL" != "$REMOTE" ]; then
            echo -e "\r${YELLOW}ðŸ“¦ Update available!${NC}"
            echo -e "${GREEN}New version on GitHub${NC}"
            echo ""
            read -p "Update now? [Y/n]: " do_update
            do_update=${do_update:-y}
            
            if [[ "$do_update" =~ ^[Yy]$ ]]; then
                echo -e "${CYAN}Updating...${NC}"
                git -C "${SCRIPT_DIR}" stash push -m "Auto-stash" 2>/dev/null || true
                
                if git -C "${SCRIPT_DIR}" pull origin main; then
                    echo -e "${GREEN}âœ… Updated successfully!${NC}"
                    echo -e "${CYAN}Restarting...${NC}"
                    exec "$0" "$@"
                else
                    echo -e "${RED}âŒ Update failed${NC}"
                fi
            fi
        else
            echo -e "\r${GREEN}âœ… Latest version${NC}"
            echo ""
        fi
    fi
}

case "${1:-}" in
    --version|-v)
        echo "deb2arch version $VERSION"
        echo "Repository: $REPO_URL"
        exit 0
        ;;
    --update|-u)
        check_updates "$@"
        exit 0
        ;;
    --help|-h)
        echo "deb2arch - .deb to Arch Package Converter"
        echo ""
        echo "Usage: $0 [OPTIONS]"
        echo ""
        echo "Options:"
        echo "  -v, --version    Show version"
        echo "  -u, --update     Check for updates"
        echo "  -h, --help       Show this help"
        exit 0
        ;;
esac

check_updates "$@"

install_deps() {
    local missing=()
    
    command -v ar &>/dev/null || missing+=("binutils")
    command -v bsdtar &>/dev/null || missing+=("libarchive")
    command -v makepkg &>/dev/null || missing+=("pacman")
    command -v python3 &>/dev/null || missing+=("python")
    command -v readelf &>/dev/null || missing+=("binutils")
    
    if [ ${#missing[@]} -gt 0 ]; then
        echo -e "${YELLOW}Installing dependencies: ${missing[*]}${NC}"
        sudo pacman -S --needed --noconfirm "${missing[@]}" || {
            echo -e "${RED}Failed to install dependencies${NC}"
            exit 1
        }
    fi
}

install_deps

python3 "${SCRIPT_DIR}/deb2arch.py"
