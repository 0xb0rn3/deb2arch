#!/usr/bin/env bash

# deb2arch - Interactive .deb to Arch Package Converter
# Engineered by: oxbv1 | 0xb0rn3
# GitHub: github.com/0xb0rn3/deb2arch
# Usage: ./run

set -e

echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë      deb2arch - .deb to Arch Converter        ‚ïë"
echo "‚ïë      Engineered by: oxbv1 | 0xb0rn3           ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""

# Check dependencies
for cmd in ar bsdtar makepkg; do
    if ! command -v $cmd &> /dev/null; then
        echo "Error: $cmd is required but not installed."
        exit 1
    fi
done

# Debian to Arch package name translation map
declare -A DEB_TO_ARCH=(
    # Common library mappings
    ["libxcb-cursor0"]="xcb-util-cursor"
    ["libncursesw5"]="ncurses"
    ["libncursesw5-dev"]="ncurses"
    ["libsox-dev"]="sox"
    ["libxml2-dev"]="libxml2"
    ["libcdio-dev"]="libcdio"
    ["libcdio-cdda-dev"]="libcdio"
    ["libcdio-paranoia-dev"]="libcdio-paranoia"
    ["libmagic-dev"]="file"
    ["libfreetype6-dev"]="freetype2"
    ["libavahi-gobject-dev"]="avahi"
    ["libsm-dev"]="libsm"
    ["libxrender-dev"]="libxrender"
    ["libfontconfig1-dev"]="fontconfig"
    ["libxext-dev"]="libxext"
    ["libgtk-3-0"]="gtk3"
    ["libnotify4"]="libnotify"
    ["libnss3"]="nss"
    ["libxtst6"]="libxtst"
    ["libatspi2.0-0"]="at-spi2-core"
    ["libdrm2"]="libdrm"
    ["libgbm1"]="mesa"
    ["libxcb-dri3-0"]="libxcb"
    ["libglib2.0-bin"]="glib2"
    ["gvfs-bin"]="gvfs"
    ["pulseaudio"]="pulseaudio"
    ["libasound2"]="alsa-lib"
    ["libgmp3-dev"]="gmp"
    ["build-essential"]="base-devel"
    
    # Remove -dev suffix (Arch doesn't split dev packages)
    [".*-dev$"]="strip-dev"
)

# Function to translate Debian package name to Arch equivalent
translate_package() {
    local deb_pkg=$1
    
    # Strip version constraints
    deb_pkg=$(echo "$deb_pkg" | sed 's/ *([^)]*)//g' | xargs)
    
    # Check direct mapping
    if [ -n "${DEB_TO_ARCH[$deb_pkg]}" ]; then
        echo "${DEB_TO_ARCH[$deb_pkg]}"
        return
    fi
    
    # Strip -dev suffix
    if [[ "$deb_pkg" =~ -dev$ ]]; then
        echo "${deb_pkg%-dev}"
        return
    fi
    
    # Strip lib prefix and version numbers for libraries
    if [[ "$deb_pkg" =~ ^lib.*[0-9]+$ ]]; then
        echo "$deb_pkg" | sed 's/[0-9]*$//'
        return
    fi
    
    # Return as-is if no translation found
    echo "$deb_pkg"
}

# Function to verify package exists in Arch repos
verify_arch_package() {
    local pkg=$1
    if pacman -Ss "^${pkg}$" &>/dev/null; then
        return 0
    else
        return 1
    fi
}

# Function to extract package info from .deb
extract_deb_info() {
    local debfile=$1
    local tmpdir=$(mktemp -d)
    
    cd "$tmpdir"
    ar x "$debfile" 2>/dev/null || true
    
    if [ -f control.tar.gz ]; then
        tar xzf control.tar.gz ./control 2>/dev/null || true
    elif [ -f control.tar.xz ]; then
        tar xJf control.tar.xz ./control 2>/dev/null || true
    elif [ -f control.tar.zst ]; then
        tar --zstd -xf control.tar.zst ./control 2>/dev/null || true
    fi
    
    if [ -f control ]; then
        cat control
    fi
    
    cd - > /dev/null
    rm -rf "$tmpdir"
}

# Get package source
echo "üì¶ Package Source"
echo "1) Local .deb file"
echo "2) URL to .deb file"
read -p "Select option [1-2]: " source_type

if [ "$source_type" == "1" ]; then
    read -p "Enter path to .deb file: " deb_path
    
    # Strip surrounding quotes if present (handles copy-paste)
    deb_path=$(echo "$deb_path" | sed "s/^['\"]//; s/['\"]$//")
    
    # Expand ~ to home directory
    deb_path="${deb_path/#\~/$HOME}"
    
    # Get absolute path
    deb_path=$(realpath "$deb_path" 2>/dev/null || echo "$deb_path")
    
    if [ ! -f "$deb_path" ]; then
        echo "Error: File not found: $deb_path"
        echo "Tried path: $deb_path"
        exit 1
    fi
    
    SOURCE_TYPE="local"
    SOURCE_PATH="$deb_path"
    DEB_FILENAME=$(basename "$deb_path")
    
    echo ""
    echo "üîç Extracting package information..."
    CONTROL_INFO=$(extract_deb_info "$deb_path")
    
elif [ "$source_type" == "2" ]; then
    read -p "Enter URL to .deb file: " deb_url
    SOURCE_TYPE="url"
    SOURCE_PATH="$deb_url"
    DEB_FILENAME=$(basename "$deb_url")
    
    echo ""
    echo "‚ö†Ô∏è  Cannot extract info from remote .deb"
    CONTROL_INFO=""
else
    echo "Invalid option"
    exit 1
fi

echo ""
echo "üìù Package Information"

# Try to suggest package name from filename
SUGGESTED_NAME=$(echo "$DEB_FILENAME" | sed 's/_.*//; s/\.deb$//' | tr '[:upper:]' '[:lower:]')
read -p "Package name [$SUGGESTED_NAME]: " pkgname
pkgname=${pkgname:-$SUGGESTED_NAME}

# Try to extract version from .deb filename or control
SUGGESTED_VER=$(echo "$DEB_FILENAME" | sed 's/.*_\([0-9][0-9.]*\).*/\1/')
if [ -n "$CONTROL_INFO" ]; then
    CONTROL_VER=$(echo "$CONTROL_INFO" | grep "^Version:" | awk '{print $2}' | cut -d- -f1)
    [ -n "$CONTROL_VER" ] && SUGGESTED_VER="$CONTROL_VER"
fi
read -p "Version [$SUGGESTED_VER]: " pkgver
pkgver=${pkgver:-$SUGGESTED_VER}

read -p "Release [1]: " pkgrel
pkgrel=${pkgrel:-1}

read -p "Architecture [x86_64]: " arch
arch=${arch:-x86_64}

# Try to extract description
if [ -n "$CONTROL_INFO" ]; then
    CONTROL_DESC=$(echo "$CONTROL_INFO" | grep "^Description:" | cut -d: -f2- | xargs)
fi
read -p "Description [$CONTROL_DESC]: " pkgdesc
pkgdesc=${pkgdesc:-$CONTROL_DESC}

read -p "URL [https://example.com]: " url
url=${url:-https://example.com}

read -p "License [custom]: " license
license=${license:-custom}

echo ""
echo "üîó Dependencies (comma-separated, or press Enter to skip)"
if [ -n "$CONTROL_INFO" ]; then
    CONTROL_DEPS=$(echo "$CONTROL_INFO" | grep "^Depends:" | cut -d: -f2- | sed 's/,/ /g; s/ *([^)]*)//g; s/  */ /g' | xargs)
    echo "Detected from .deb: $CONTROL_DEPS"
    echo ""
    echo "üîÑ Translating dependencies to Arch equivalents..."
    
    # Translate dependencies
    TRANSLATED_DEPS=()
    MISSING_DEPS=()
    for deb_dep in $CONTROL_DEPS; do
        arch_dep=$(translate_package "$deb_dep")
        
        # Skip special cases
        if [ "$arch_dep" == "strip-dev" ]; then
            continue
        fi
        
        # Verify package exists
        if verify_arch_package "$arch_dep"; then
            TRANSLATED_DEPS+=("$arch_dep")
            echo "  ‚úì $deb_dep ‚Üí $arch_dep"
        else
            # Check if original name exists
            if verify_arch_package "$deb_dep"; then
                TRANSLATED_DEPS+=("$deb_dep")
                echo "  ‚úì $deb_dep (no translation needed)"
            else
                MISSING_DEPS+=("$deb_dep ‚Üí $arch_dep?")
                echo "  ‚ö† $deb_dep ‚Üí $arch_dep (not found in repos, check AUR)"
            fi
        fi
    done
    
    if [ ${#MISSING_DEPS[@]} -gt 0 ]; then
        echo ""
        echo "‚ö†Ô∏è  Some dependencies couldn't be verified:"
        for missing in "${MISSING_DEPS[@]}"; do
            echo "    - $missing"
        done
        echo "You may need to install them from AUR or adjust manually."
    fi
    
    echo ""
    SUGGESTED_DEPS=$(IFS=, ; echo "${TRANSLATED_DEPS[*]}")
    read -p "Dependencies [$SUGGESTED_DEPS]: " depends_input
    depends_input=${depends_input:-$SUGGESTED_DEPS}
else
    read -p "Dependencies: " depends_input
fi

if [ -n "$depends_input" ]; then
    IFS=',' read -ra DEPS <<< "$depends_input"
    depends_array="depends=("
    for dep in "${DEPS[@]}"; do
        dep=$(echo "$dep" | xargs)
        depends_array+="'$dep' "
    done
    depends_array+=")"
else
    depends_array="depends=()"
fi

echo ""
read -p "üìÅ Build directory [/tmp/deb2arch-build]: " build_dir
build_dir=${build_dir:-/tmp/deb2arch-build}

# Strip quotes from build directory
build_dir=$(echo "$build_dir" | sed "s/^['\"]//; s/['\"]$//")
build_dir="${build_dir/#\~/$HOME}"

# Create build directory first
mkdir -p "$build_dir"

read -p "üíæ Save PKGBUILD to [${build_dir}/PKGBUILD]: " pkgbuild_save
if [ -z "$pkgbuild_save" ] || [ "$pkgbuild_save" == "${build_dir}/PKGBUILD" ]; then
    pkgbuild_save="${build_dir}/PKGBUILD"
else
    # Strip quotes and expand path
    pkgbuild_save=$(echo "$pkgbuild_save" | sed "s/^['\"]//; s/['\"]$//")
    pkgbuild_save="${pkgbuild_save/#\~/$HOME}"
    
    # If it's a directory, append PKGBUILD filename
    if [ -d "$pkgbuild_save" ]; then
        pkgbuild_save="${pkgbuild_save}/PKGBUILD"
    fi
fi

read -p "üì¶ Save built package to [${build_dir}]: " pkg_save_dir
if [ -z "$pkg_save_dir" ] || [ "$pkg_save_dir" == "${build_dir}" ]; then
    pkg_save_dir="${build_dir}"
else
    # Strip quotes and expand path
    pkg_save_dir=$(echo "$pkg_save_dir" | sed "s/^['\"]//; s/['\"]$//")
    pkg_save_dir="${pkg_save_dir/#\~/$HOME}"
fi

echo ""
read -p "üöÄ Install package after building? [y/N]: " install_pkg
install_pkg=${install_pkg:-n}

# Create directories
mkdir -p "$(dirname "$pkgbuild_save")"
mkdir -p "$pkg_save_dir"

# Generate PKGBUILD
echo ""
echo "‚úçÔ∏è  Generating PKGBUILD..."

cat > "$pkgbuild_save" << EOF
# Maintainer: oxbv1 | 0xb0rn3 (github.com/0xb0rn3/deb2arch)
pkgname=$pkgname
pkgver=$pkgver
pkgrel=$pkgrel
pkgdesc="$pkgdesc"
arch=('$arch')
url="$url"
license=('$license')
$depends_array
EOF

if [ "$SOURCE_TYPE" == "local" ]; then
    cat >> "$pkgbuild_save" << EOF
source=("file://$SOURCE_PATH")
sha256sums=('SKIP')

package() {
    cd "\${srcdir}"
    
    # Extract .deb
    ar x "$DEB_FILENAME"
    
    # Extract data
    if [ -f data.tar.xz ]; then
        bsdtar -xf data.tar.xz -C "\${pkgdir}"
    elif [ -f data.tar.gz ]; then
        bsdtar -xf data.tar.gz -C "\${pkgdir}"
    elif [ -f data.tar.zst ]; then
        bsdtar -xf data.tar.zst -C "\${pkgdir}"
    fi
    
    # Fix permissions
    find "\${pkgdir}" -type d -exec chmod 755 {} +
    find "\${pkgdir}" -type f -exec chmod 644 {} +
    find "\${pkgdir}/usr/bin" -type f -exec chmod 755 {} + 2>/dev/null || true
    find "\${pkgdir}/opt" -type f -executable -exec chmod 755 {} + 2>/dev/null || true
}
EOF
else
    cat >> "$pkgbuild_save" << EOF
source=("$SOURCE_PATH")
sha256sums=('SKIP')

package() {
    cd "\${srcdir}"
    
    # Extract .deb
    ar x "$DEB_FILENAME"
    
    # Extract data
    if [ -f data.tar.xz ]; then
        bsdtar -xf data.tar.xz -C "\${pkgdir}"
    elif [ -f data.tar.gz ]; then
        bsdtar -xf data.tar.gz -C "\${pkgdir}"
    elif [ -f data.tar.zst ]; then
        bsdtar -xf data.tar.zst -C "\${pkgdir}"
    fi
    
    # Fix permissions
    find "\${pkgdir}" -type d -exec chmod 755 {} +
    find "\${pkgdir}" -type f -exec chmod 644 {} +
    find "\${pkgdir}/usr/bin" -type f -exec chmod 755 {} + 2>/dev/null || true
    find "\${pkgdir}/opt" -type f -executable -exec chmod 755 {} + 2>/dev/null || true
}
EOF
fi

echo "‚úÖ PKGBUILD created: $pkgbuild_save"
echo ""
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
cat "$pkgbuild_save"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""

# Build package
read -p "üî® Build package now? [Y/n]: " build_now
build_now=${build_now:-y}

if [[ "$build_now" =~ ^[Yy]$ ]]; then
    echo ""
    echo "üî® Building package..."
    cd "$build_dir"
    
    if makepkg -sf --noconfirm 2>&1 | tee /tmp/deb2arch-build.log; then
        echo ""
        echo "‚úÖ Package built successfully!"
        
        # Move package to save directory
        PKG_FILE=$(ls -t ${pkgname}-${pkgver}-${pkgrel}-*.pkg.tar.zst 2>/dev/null | head -1)
        
        if [ -n "$PKG_FILE" ] && [ "$pkg_save_dir" != "$build_dir" ]; then
            mv "$PKG_FILE" "$pkg_save_dir/"
            echo "üì¶ Package saved to: ${pkg_save_dir}/${PKG_FILE}"
            PKG_FILE="${pkg_save_dir}/${PKG_FILE}"
        else
            echo "üì¶ Package location: ${build_dir}/${PKG_FILE}"
        fi
        
        # Install if requested
        if [[ "$install_pkg" =~ ^[Yy]$ ]]; then
            echo ""
            echo "üöÄ Installing package..."
            sudo pacman -U "$PKG_FILE" --noconfirm
            echo "‚úÖ Package installed!"
        fi
    else
        echo "‚ùå Build failed!"
        echo ""
        echo "üí° Common issues:"
        echo "   - Missing dependencies (check AUR for unavailable packages)"
        echo "   - Edit PKGBUILD manually: $pkgbuild_save"
        echo "   - Check build log: /tmp/deb2arch-build.log"
        exit 1
    fi
else
    echo "Build skipped. To build manually:"
    echo "  cd $build_dir"
    echo "  makepkg -sf"
fi

echo ""
echo "‚ú® Done!"
