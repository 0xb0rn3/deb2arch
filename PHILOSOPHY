# deb2arch - Technical Architecture

## ğŸ¯ Core Philosophy

**Zero External Dependencies** - Built for security professionals and system architects who value:
- Clean system state
- No pip pollution
- No AUR dependency hell
- 100% official Arch repos
- Self-contained operation

## ğŸ—ï¸ Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     deb2arch Tool                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Bootstrap Layer                                         â”‚
â”‚  â”œâ”€ Dependency Detection                                â”‚
â”‚  â”œâ”€ Auto-Installation (pacman only)                     â”‚
â”‚  â””â”€ Environment Validation                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Analysis Engine                                         â”‚
â”‚  â”œâ”€ Python Analyzer (stdlib only)                       â”‚
â”‚  â”‚   â”œâ”€ ELF Binary Scanner                              â”‚
â”‚  â”‚   â”œâ”€ readelf Integration                             â”‚
â”‚  â”‚   â””â”€ Libraryâ†’Package Mapper                          â”‚
â”‚  â”œâ”€ Bash Fallback (ldd-based)                           â”‚
â”‚  â””â”€ Control File Parser                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Translation Layer                                       â”‚
â”‚  â”œâ”€ Debianâ†’Arch Package Map                             â”‚
â”‚  â”œâ”€ Package Verification (pacman -Ss)                   â”‚
â”‚  â””â”€ Dependency Deduplication                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Build System                                            â”‚
â”‚  â”œâ”€ PKGBUILD Generator                                  â”‚
â”‚  â”œâ”€ Permission Fixer                                    â”‚
â”‚  â””â”€ Silent Builder (spinner UI)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ Dependency Management

### Auto-Installation System

The tool automatically installs missing dependencies using **only** system packages:

```bash
# Dependencies checked:
- binutils    (ar, readelf)
- libarchive  (bsdtar)
- pacman      (makepkg)
- python      (interpreter only)
- glibc       (ldd)
```

### Why No pip? Why --break-system-packages Not Needed?

**The Problem with pip on Arch:**
```bash
# âŒ DON'T DO THIS (old way):
pip install pyelftools --break-system-packages
pip install lief --break-system-packages

# Problems:
# 1. Conflicts with system packages
# 2. Breaks pacman dependency tracking
# 3. Security risk (unverified sources)
# 4. Package management nightmare
```

**Our Solution:**
```bash
# âœ… DO THIS (our way):
# Use Python stdlib only:
- subprocess (for readelf)
- pathlib (for file traversal)
- re (for parsing)
- sys (for I/O)

# Result:
# - No pip required
# - No --break-system-packages flag
# - 100% reproducible
# - Security auditable
```

## ğŸ”¬ Dependency Detection Engine

### Three-Tier Detection

```python
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tier 1: Binary Analysis              â”‚
â”‚  â”œâ”€ Scan .deb extraction              â”‚
â”‚  â”œâ”€ Find ELF binaries (magic: 0x7f45) â”‚
â”‚  â”œâ”€ Run readelf -d on each            â”‚
â”‚  â””â”€ Extract NEEDED libraries          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tier 2: Library Mapping              â”‚
â”‚  â”œâ”€ libQt5*.so â†’ qt5-base             â”‚
â”‚  â”œâ”€ libgtk-3.so â†’ gtk3                â”‚
â”‚  â”œâ”€ libssl.so â†’ openssl               â”‚
â”‚  â””â”€ Pattern matching + heuristics     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tier 3: Control File Translation     â”‚
â”‚  â”œâ”€ Parse Depends: field              â”‚
â”‚  â”œâ”€ Translate Debianâ†’Arch names       â”‚
â”‚  â”œâ”€ Verify with pacman -Ss            â”‚
â”‚  â””â”€ Filter system packages            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Python Analyzer (No External Deps)

```python
# Uses ONLY Python standard library:
import subprocess  # Run readelf
import re          # Parse output
from pathlib import Path  # File traversal

# No pip packages needed:
# âŒ pyelftools
# âŒ lief
# âŒ elftools
# âŒ pwntools

# Instead: We call system readelf binary
# Pros:
# - Already installed (binutils)
# - Maintained by Arch
# - Security vetted
# - No pip conflicts
```

## ğŸ¨ User Experience Design

### Minimal Build Output

**Before (noisy):**
```
==> Making package: test 1.0.0-1 (Sat 07 Dec 2024)
==> Checking runtime dependencies...
==> Checking buildtime dependencies...
==> Retrieving sources...
==> Extracting sources...
[100+ lines of spam]
```

**After (clean):**
```
ğŸ”¨ Building package... â ‹
âœ… Package built successfully!
```

### Interactive Flow

```
User Input              Tool Response
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
./run                   â†’ Check dependencies
                        â†’ Auto-install if needed
                        
Select .deb source      â†’ Extract metadata
                        â†’ Suggest defaults
                        
Choose dep mode         â†’ Scan binaries (Python)
                        â†’ Translate deps (Bash)
                        â†’ Verify packages (pacman)
                        
Confirm build           â†’ Silent build (spinner)
                        â†’ Show result only
```

## ğŸ›¡ï¸ Security Architecture

### Trust Chain

```
Official Arch Repos (pacman)
    â†“
System Python (no pip)
    â†“
System binutils (readelf)
    â†“
deb2arch (our code)
    â†“
User's .deb package
```

### No Trust Required For:
- âŒ PyPI packages
- âŒ AUR maintainers
- âŒ pip dependencies
- âŒ External analyzers

### Only Trust Required For:
- âœ… Arch official repos (already trusted)
- âœ… Our auditable bash/python code
- âœ… User's own .deb file

## ğŸ’» Code Organization

### File Structure
```
deb2arch/
â”œâ”€â”€ run (main script)
â”‚   â”œâ”€â”€ Bootstrap (dependency installer)
â”‚   â”œâ”€â”€ Analysis (Python generator)
â”‚   â”œâ”€â”€ Translation (Debâ†’Arch map)
â”‚   â”œâ”€â”€ Build (PKGBUILD generator)
â”‚   â””â”€â”€ UI (spinner, colors)
â”‚
â””â”€â”€ /tmp/deb2arch_analyzer.py (generated)
    â”œâ”€â”€ ELF scanner
    â”œâ”€â”€ Library mapper
    â””â”€â”€ Package suggester
```

### Language Choice Rationale

**Bash (Main Script):**
- Native to Arch
- Perfect for pacman/makepkg integration
- Fast for file operations
- No compilation needed

**Python (Analyzer):**
- Stdlib has perfect file/subprocess tools
- Better data structures for mapping
- No external deps needed (key point!)
- Cross-platform if needed later

**Why Not Go/Rust?**
- Would require compilation
- Adds dependency (go/rustc toolchain)
- Our Python is stdlib-only anyway
- Bash+Python combo is lighter

## ğŸš€ Performance Characteristics

### Benchmark (Typical .deb)
```
Task                    Time        Method
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Dependency check        <100ms      pacman -Q
Auto-install deps       ~2-5s       pacman -S
Extract .deb info       ~200ms      ar + tar
Binary analysis         ~1-3s       Python + readelf
Translate deps          ~500ms      Bash + pacman -Ss
Build package           ~5-30s      makepkg
Total (auto mode)       ~10-40s     End-to-end
```

### Memory Footprint
```
- Bash process:        ~2MB
- Python analyzer:     ~8MB
- Temp extraction:     <100MB (depends on .deb)
- Build artifacts:     Varies
```

## ğŸ¯ Design Patterns

### 1. **Self-Healing Bootstrap**
```bash
# Pattern: Check â†’ Prompt â†’ Install â†’ Verify
install_dependencies() {
    detect_missing()
    if missing: 
        ask_user()
        pacman -S --needed --noconfirm
        verify_installed()
}
```

### 2. **Embedded Code Generation**
```bash
# Pattern: Generate analyzer on-the-fly
create_python_analyzer() {
    cat > /tmp/analyzer.py << 'EOF'
    [full Python script]
    EOF
    chmod +x
}
# Benefit: Single file distribution
```

### 3. **Progressive Enhancement**
```bash
# Pattern: Best available method
if python3 + readelf: use_advanced_analysis()
elif ldd: use_simple_analysis()
else: use_manual_input()
```

### 4. **Silent Success, Verbose Failure**
```bash
# Pattern: Spinner on success, logs on failure
makepkg > /tmp/build.log 2>&1 &
show_spinner()
if fail: tail -n 20 /tmp/build.log
```

## ğŸ” Threat Model

### What We Protect Against:
- âœ… pip package supply chain attacks
- âœ… Malicious PyPI packages
- âœ… Dependency confusion
- âœ… System package conflicts

### What We Don't Handle:
- âŒ Malicious .deb files (user responsibility)
- âŒ Compromised Arch repos (outside scope)
- âŒ Local privilege escalation (use sudo wisely)

## ğŸ“Š Comparison Matrix

| Feature | deb2arch | debtap | alien |
|---------|----------|--------|-------|
| Auto-install deps | âœ… Yes | âŒ No | âŒ No |
| Python stdlib only | âœ… Yes | âŒ No (perl) | âŒ No (perl) |
| Binary analysis | âœ… Yes | âš ï¸ Basic | âŒ No |
| Interactive UI | âœ… Yes | âš ï¸ Partial | âŒ No |
| Silent build | âœ… Yes | âŒ No | âŒ No |
| /opt permission fix | âœ… Yes | âš ï¸ Partial | âŒ No |
| Custom maintainer | âœ… Yes | âŒ No | âŒ No |

## ğŸ“ For Security Researchers

### Why This Approach Matters:

**Threat Modeling:**
```
Attack Surface Reduction:
- No pip = No PyPI attacks
- No AUR = No untrusted maintainers
- Stdlib only = Minimal code review surface
- Pacman only = Official repo integrity
```

**Auditability:**
```bash
# Full code in single file:
wc -l run
# ~600 lines of auditable bash

# Python analyzer:
wc -l /tmp/deb2arch_analyzer.py
# ~150 lines of auditable Python

# Total: <1000 lines
# Compare to: debtap (2000+), alien (5000+)
```

**Reproducibility:**
```
Same .deb + Same Arch system = Same package
No pip version pinning needed
No virtualenv complexity
No poetry/pipenv lock files
```

## ğŸ”„ Future Enhancements

### Planned (Maintaining Philosophy):
- [ ] AUR package verification helper
- [ ] Multi-arch support (aarch64)
- [ ] Batch conversion mode
- [ ] GPG signature verification
- [ ] Sandbox build option (systemd-nspawn)

### Not Planned (Breaks Philosophy):
- âŒ pip package dependencies
- âŒ External library requirements
- âŒ GUI (adds Qt/GTK deps)
- âŒ AUR auto-upload (trust issues)

## ğŸ“ Contributing Guidelines

### Code Standards:
1. **No external dependencies** (pacman packages only)
2. **No pip packages** (Python stdlib only)
3. **Bash style:** 
   - 4-space indent
   - `[[ ]]` for tests
   - `$()` for subshells
4. **Python style:**
   - PEP 8 compliant
   - Type hints optional
   - Docstrings required

### Testing Checklist:
```bash
# Test clean system:
docker run -it archlinux bash
# Install deb2arch, run tests

# Test with various .debs:
- Qt applications
- GTK applications
- CLI tools
- /opt installers

# Verify no pip usage:
grep -r "pip install" .  # Should be empty
grep -r "import.*site-packages" .  # Should be empty
```

## ğŸ† Design Wins

### 1. **Security First**
No pip = No supply chain attacks

### 2. **Simplicity**
Single file, clear code, easy audit

### 3. **Performance**
Native tools, no Python package overhead

### 4. **Maintainability**
No dependency version hell

### 5. **User Experience**
Auto-install, spinner UI, clean output

---

**Built for professionals who understand:**
- Supply chain security
- System integrity
- Reproducible builds
- Minimal attack surface

**Engineered by: 0xb0rn3**
*Where security meets craftsmanship*
